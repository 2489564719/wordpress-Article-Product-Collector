<?php
/*   __________________________________________________
    |  Obfuscated by YAK Pro - Php Obfuscator  2.0.17  |
    |              on 2025-11-22 08:59:56              |
    |    GitHub: https://github.com/pk-fr/yakpro-po    |
    |__________________________________________________|
*/
 if (!defined('ABSPATH')) { exit; } class SBB_Collector_Admin_SingleUI { public static function render() : void { goto y7fBc; P6oNM: echo '<button type="submit" class="button button-primary" name="sbb_submit">抓取</button>'; goto LEzF5; y7fBc: if (!current_user_can('manage_options')) { wp_die('权限不足'); } goto msnic; cN1vX: if (is_array($pcP0P)) { echo '<hr><h2>控制台日志</h2><pre style="background:#111;color:#eee;padding:12px;max-height:360px;overflow:auto">' . esc_html($pcP0P['log'] ?? '') . '</pre>'; echo '<h2>预览</h2><div style="background:#fff;border:1px solid #ccd0d4;padding:12px;max-width:980px;overflow:auto">' . ($pcP0P['preview'] ?? '') . '</div>'; } goto POkRb; gG78t: echo '<input type="hidden" name="action" value="sbb_collector_single">'; goto oUvIo; msnic: $zmWOa = isset($_GET['sbb_token']) ? sanitize_key($_GET['sbb_token']) : ''; goto zj2eF; H8wsu: echo '</form>'; goto cN1vX; Himk0: echo '</p>'; goto H8wsu; GDfba: echo '<p style="margin-top:16px;font-size:16px;font-weight:600;color:#0073aa;">当前为 <strong>' . esc_html($xrXRn) . '</strong> 采集</p>'; goto s4pnX; LEzF5: echo '<label style="margin-left:12px;vertical-align:middle;"><input type="checkbox" name="save_staging" value="1"> 保存为暂存并本地化图片</label>'; goto Himk0; hmOdz: echo '<tr><th>规则JSON（可选，多规则）</th><td><textarea name="rules_json" rows="6" class="large-text" placeholder="' . esc_attr('[{"name":"标题","selector":"h1.entry-title","type":"text"},{"name":"描述","selector":".entry-content","type":"html"}]') . '"></textarea><p class="description">若留空，则使用“采集配置”页保存的全局规则；否则使用上面的单条选择器。</p></td></tr>'; goto sN4CF; PYMg4: echo '<tr><th>URL</th><td><input name="url" type="url" class="regular-text" required></td></tr>'; goto KpKnL; s4pnX: echo '<form method="post" action="' . esc_url(admin_url('admin-post.php')) . '">'; goto Avsuo; POkRb: echo '</div>'; goto eROVS; Avsuo: wp_nonce_field('sbb_collector_single'); goto gG78t; oUvIo: echo '<table class="form-table"><tbody>'; goto PYMg4; nrec1: $xrXRn = $W3cNV === 'post' ? '文章' : '产品'; goto GDfba; tBhvy: echo '<tr><th>类型</th><td><select name="type"><option value="html">HTML</option><option value="text">Text</option><option value="attr">Attr</option></select> 属性名：<input name="attr" type="text" placeholder="src|href|content"></td></tr>'; goto hmOdz; sN4CF: echo '</tbody></table>'; goto FtE7a; B1Oz0: $W3cNV = SBB_Collector_ConfigStore::get_mode(); goto nrec1; zj2eF: $pcP0P = $zmWOa ? get_transient($zmWOa) : null; goto am9Gq; am9Gq: echo '<div class="wrap"><h1>单链接调试</h1>'; goto B1Oz0; FtE7a: echo '<p class="submit">'; goto P6oNM; KpKnL: echo '<tr><th>CSS选择器</th><td><input name="selector" type="text" class="regular-text" placeholder=".entry-content"></td></tr>'; goto tBhvy; eROVS: } public static function handle() : void { goto UW9dN; w4hGn: $A4Mu9 = sanitize_text_field($_POST['selector'] ?? ''); goto BoJ0y; BoJ0y: $S0ajy = sanitize_text_field($_POST['type'] ?? 'html'); goto zvgH9; rYOM8: $AtZ0M = ''; goto IlaSO; ZNvY6: if ($Bzd5Q) { goto YIfDx; YIfDx: $W3cNV = SBB_Collector_ConfigStore::get_mode(); goto tFway; tFway: $h9COL = SBB_Collector_StagingStore::create('暂存 - ' . (wp_parse_url($ShF28, PHP_URL_HOST) ?: $ShF28), ['source_url' => $ShF28, 'rules' => $US2sW, 'content_type' => $W3cNV]); goto lUISW; lUISW: SBB_Collector_Jobs::enqueue_staging_process($h9COL); goto Ypw9i; Ypw9i: $l_bxf->info('Staging created & enqueued', ['id' => $h9COL, 'content_type' => $W3cNV]); goto Cv0BZ; Cv0BZ: } goto ekK4S; uy5A2: $US2sW = SBB_Collector_RuleManager::normalize($GLzg9 ?: []); goto bCVh0; jAtwi: $MjwT7 = wp_unslash($_POST['rules_json'] ?? ''); goto S13My; bCVh0: if (empty($US2sW) && !empty($A4Mu9)) { $US2sW = [['name' => '内容', 'selector' => $A4Mu9, 'type' => $S0ajy, 'attr' => $Rfeqy]]; } goto MlTz2; XKdch: $ShF28 = esc_url_raw(trim($_POST['url'] ?? '')); goto w4hGn; MlTz2: $l_bxf = new SBB_Collector_Logger(); goto jIcYv; jIcYv: $zmWOa = 'sbb_' . wp_generate_uuid4(); goto s6Ctr; AkOMa: $Bzd5Q = !empty($_POST['save_staging']); goto jAtwi; IlaSO: foreach ($US2sW as $p36LP) { goto VQGQS; Kk3mV: if (!$F13Sc) { continue; } goto rQGzB; oMMRj: $V16cl = sanitize_text_field($p36LP['type'] ?? 'html'); goto j_4yP; W2goE: if (array_key_exists('value', $p36LP) && empty($p36LP['selector']) && empty($p36LP['builtin'])) { goto NXaFH; sADAY: if ($pWWEe !== '') { $AtZ0M .= '<p>' . esc_html($pWWEe) . '</p>'; } goto nrWOP; kC5iV: if ($mdMyK) { $AtZ0M .= '<h3>' . esc_html($mdMyK) . '</h3>'; } goto sADAY; nrWOP: continue; goto ruUo0; NXaFH: $pWWEe = (string) $p36LP['value']; goto kC5iV; ruUo0: } goto Jwz_8; rQGzB: $sY0sO = SBB_Collector_Parser::extract($cbr0c, $F13Sc, $V16cl, $dcPKX, $l_bxf); goto pSTqG; Jwz_8: if (!empty($p36LP['builtin'])) { goto mTMxE; mTMxE: $DBIor = $p36LP['builtin']; goto RWaVZ; P8Wt5: if ($mdMyK) { $AtZ0M .= '<h3>' . esc_html($mdMyK) . '</h3>'; } goto hc63L; hc63L: if ($y94Xk !== '') { $AtZ0M .= '<p>' . esc_html($y94Xk) . '</p>'; } goto dljnM; RWaVZ: $y94Xk = ''; goto r9HqI; r9HqI: if ($DBIor === 'title') { $y94Xk = SBB_Collector_Parser::extract_title($cbr0c); } elseif ($DBIor === 'desc') { $y94Xk = SBB_Collector_Parser::extract_meta_description($cbr0c); } goto P8Wt5; dljnM: continue; goto SPerl; SPerl: } goto ASW0p; VQGQS: $mdMyK = sanitize_text_field($p36LP['name'] ?? ''); goto W2goE; nFuVK: foreach ($sY0sO as $I2qZI) { if ($I2qZI['kind'] !== 'html') { $AtZ0M .= '<p>' . esc_html($I2qZI['content']) . '</p>'; } else { $AtZ0M .= wp_kses_post($I2qZI['content']); } } goto AzZT1; j_4yP: $dcPKX = sanitize_text_field($p36LP['attr'] ?? ''); goto Kk3mV; ASW0p: $F13Sc = sanitize_text_field($p36LP['selector'] ?? ''); goto oMMRj; pSTqG: if ($mdMyK) { $AtZ0M .= '<h3>' . esc_html($mdMyK) . '</h3>'; } goto nFuVK; AzZT1: } goto ZNvY6; giMl3: if (empty($GLzg9)) { $F0o8P = SBB_Collector_ConfigStore::all(); if (is_array($F0o8P) && !empty($F0o8P)) { $GLzg9 = $F0o8P; } } goto uy5A2; zvgH9: $Rfeqy = sanitize_text_field($_POST['attr'] ?? ''); goto AkOMa; os95q: exit; goto S5uMz; s6Ctr: if ($Bzd5Q && SBB_Collector_StagingStore::is_source_url_exists($ShF28)) { goto QcAPU; oMD7j: set_transient($zmWOa, ['error' => '源 URL 已存在，跳过采集。', 'log' => $l_bxf->text(), 'preview' => ''], MINUTE_IN_SECONDS * 10); goto HH0jw; OQEDA: wp_redirect(add_query_arg('sbb_token', $zmWOa, $qYNxA)); goto XqBq2; QcAPU: $l_bxf->warn('Source URL already exists, skipping.', ['url' => $ShF28]); goto oMD7j; HH0jw: $qYNxA = wp_get_referer(); goto hPZcz; hPZcz: if (!$qYNxA) { $qYNxA = admin_url('admin.php?page=sbb-collector'); } goto OQEDA; XqBq2: exit; goto Jxw4M; Jxw4M: } goto FMqDH; S13My: $GLzg9 = json_decode($MjwT7, true); goto giMl3; ekK4S: set_transient($zmWOa, ['log' => $l_bxf->text(), 'preview' => $AtZ0M], MINUTE_IN_SECONDS * 10); goto TuTKg; KNkKS: check_admin_referer('sbb_collector_single'); goto XKdch; TuTKg: wp_redirect(add_query_arg('sbb_token', $zmWOa, admin_url('admin.php?page=sbb-collector'))); goto os95q; UW9dN: if (!current_user_can('manage_options')) { wp_die('权限不足'); } goto KNkKS; SLx7W: if ($cbr0c === '') { goto ZbmS9; MMWHX: wp_redirect(add_query_arg('sbb_token', $zmWOa, admin_url('admin.php?page=sbb-collector'))); goto qB0B4; ZbmS9: set_transient($zmWOa, ['error' => '抓取失败', 'log' => $l_bxf->text(), 'preview' => ''], MINUTE_IN_SECONDS * 10); goto MMWHX; qB0B4: exit; goto OQgyY; OQgyY: } goto rYOM8; FMqDH: if (!$ShF28 || empty($US2sW)) { goto ZepV5; ZepV5: $l_bxf->error('参数不完整或规则无效', ['url' => $ShF28, 'rules_count' => count($US2sW)]); goto jI2w7; jI2w7: set_transient($zmWOa, ['error' => '参数不完整或规则无效', 'log' => $l_bxf->text(), 'preview' => ''], MINUTE_IN_SECONDS * 10); goto d294A; NrI0g: exit; goto Tebl9; d294A: wp_redirect(add_query_arg('sbb_token', $zmWOa, admin_url('admin.php?page=sbb-collector'))); goto NrI0g; Tebl9: } goto aJaiF; aJaiF: $cbr0c = SBB_Collector_Crawler::fetch($ShF28, $l_bxf); goto SLx7W; S5uMz: } }
