<?php
/*   __________________________________________________
    |  Obfuscated by YAK Pro - Php Obfuscator  2.0.17  |
    |              on 2025-11-22 08:59:56              |
    |    GitHub: https://github.com/pk-fr/yakpro-po    |
    |__________________________________________________|
*/
 if (!defined('ABSPATH')) { exit; } class SBB_Collector_Admin_StagingUI { public static function add_hooks(string $M0w0H) { add_action('load-' . $M0w0H, [__CLASS__, 'handle_view_action']); } public static function handle_view_action() { if (isset($_GET['view_staging'])) { self::render_view_staging(intval($_GET['view_staging'])); exit; } } public static function render() : void { goto acKGb; FriYf: self::handle_bulk_actions(); goto JKxFU; rEM6w: echo '</form></div>'; goto wWjsS; WLC81: echo '<p style="margin-top:16px;font-size:16px;font-weight:600;color:#0073aa;">当前为 <strong>' . esc_html($xrXRn) . '</strong> 采集</p>'; goto iSlSe; a1BRX: echo '<form method="post">'; goto yQtA3; iSlSe: if (isset($_GET['error_code']) && $_GET['error_code'] === 'no_mapping') { echo '<div id="message" class="error notice is-dismissible"><p><strong>操作失败：</strong>发布配置为空，无法进行批量发布。 <a href="' . admin_url('admin.php?page=sbb-collector-publish-config') . '">请先设置字段映射</a></p></div>'; } goto fu9x6; Z2Zq0: $HDEgp = new SBB_Collector_Staging_List_Table(); goto lLtyM; NCdOo: $xrXRn = $W3cNV === 'post' ? '文章' : '产品'; goto WLC81; lLtyM: $HDEgp->prepare_items(); goto FriYf; lapnX: $W3cNV = SBB_Collector_ConfigStore::get_mode(); goto NCdOo; acKGb: if (!current_user_can('manage_options')) { wp_die('权限不足'); } goto Z2Zq0; JKxFU: echo '<div class="wrap"><h1>采集暂存管理</h1>'; goto lapnX; yQtA3: $HDEgp->display(); goto rEM6w; fu9x6: if (isset($_GET['published']) || isset($_GET['skipped']) || isset($_GET['deleted'])) { goto rP1C5; rP1C5: $oFIAg = isset($_GET['published']) ? intval($_GET['published']) : 0; goto LtRl_; bQtPY: if ($akl50 > 0) { echo ' ' . esc_html($akl50) . ' 个项目因已发布而被跳过。'; } goto qrCoK; no3L2: if ($oFIAg > 0) { echo esc_html($oFIAg) . ' 个项目已成功发布。'; } goto bQtPY; qrCoK: if ($rvLmz > 0) { echo ' ' . esc_html($rvLmz) . ' 个项目已被删除。'; } goto ihoFm; LtRl_: $akl50 = isset($_GET['skipped']) ? intval($_GET['skipped']) : 0; goto sWuZS; sWuZS: $rvLmz = isset($_GET['deleted']) ? intval($_GET['deleted']) : 0; goto XI0jF; XI0jF: echo '<div id="message" class="updated notice is-dismissible"><p>'; goto no3L2; ihoFm: echo '</p></div>'; goto L7oLZ; L7oLZ: } goto a1BRX; wWjsS: } private static function handle_bulk_actions() { goto i325v; qY2oH: if (empty($aUipK)) { return; } goto XLcTD; LvtUq: if ($MMVuJ === 'sbb_bulk_publish' || $MMVuJ === 'sbb_bulk_publish_draft') { goto FKpZU; FKpZU: $oFIAg = 0; goto CQxi4; fUz8h: if (empty($y22_H)) { goto QWjYR; OIs5m: wp_redirect($yOu79); goto NdEhn; NdEhn: exit; goto aA9ht; QWjYR: $yOu79 = add_query_arg('error_code', 'no_mapping', $yOu79); goto OIs5m; aA9ht: } goto RzxuI; RzxuI: foreach ($aUipK as $h9COL) { goto Zgt_U; t2Lty: $PhYkQ = is_array($Elm06) ? $Elm06['content_type'] ?? 'product' : 'product'; goto Xwqza; Xwqza: if ($W3cNV === 'post') { goto so89w; xPkCb: $VGZh2 = SBB_Collector_Admin_PublishUI::_create_post_from_staging($h9COL, $y22_H, $TxT42, (int) $WFZO8); goto tFAyZ; so89w: if (get_post_meta($h9COL, '_sbb_published_post_id', true)) { $akl50++; continue; } goto xPkCb; tFAyZ: if ($VGZh2) { update_post_meta($h9COL, '_sbb_published_post_id', $VGZh2); $oFIAg++; } goto jeeY3; jeeY3: } else { goto p8VkF; OxRsd: if ($o7hKk) { update_post_meta($h9COL, '_sbb_published_product_id', $o7hKk); $oFIAg++; } goto YC4m0; p8VkF: if (get_post_meta($h9COL, '_sbb_published_product_id', true)) { $akl50++; continue; } goto NTF97; NTF97: $o7hKk = SBB_Collector_Admin_PublishUI::_create_product_from_staging($h9COL, $y22_H, $TxT42, (int) $WFZO8); goto OxRsd; YC4m0: } goto M55Tb; Zgt_U: $Elm06 = get_post_meta($h9COL, SBB_Collector_StagingStore::META_KEY, true); goto t2Lty; M55Tb: } goto TJCbJ; TeeFD: $y22_H = $Y3pJ_['mapping'] ?? []; goto RrxEC; RrxEC: $WFZO8 = $Y3pJ_['product_cat_id'] ?? 0; goto ewtEU; TJCbJ: $yOu79 = add_query_arg(['published' => $oFIAg, 'skipped' => $akl50], $yOu79); goto hBKHg; ETReL: if ($MMVuJ === 'sbb_bulk_publish_draft') { $TxT42 = 'draft'; } goto fUz8h; ewtEU: $TxT42 = $Y3pJ_['direct_publish'] ?? false ? 'publish' : 'draft'; goto ETReL; K5tJD: $W3cNV = SBB_Collector_ConfigStore::get_mode(); goto IEZku; IEZku: $Y3pJ_ = SBB_Collector_ConfigStore::get_publish_config(); goto TeeFD; CQxi4: $akl50 = 0; goto K5tJD; hBKHg: } goto oeg7C; DYnyY: if (!isset($_POST['_wpnonce']) || !wp_verify_nonce($_POST['_wpnonce'], 'bulk-' . $HDEgp->get_plural())) { wp_die('安全校验失败'); } goto VvtD5; XLcTD: $aUipK = array_map('intval', $aUipK); goto WLM9k; WLM9k: $yOu79 = remove_query_arg(['deleted', 'published', 'skipped', '_wpnonce', 'action', 'action2'], wp_get_referer()); goto KvYt2; KvYt2: if ($MMVuJ === 'sbb_bulk_delete') { goto x4zmn; zC4hI: $yOu79 = add_query_arg('deleted', $rvLmz, $yOu79); goto v51cd; x4zmn: $rvLmz = 0; goto B2lQg; B2lQg: foreach ($aUipK as $h9COL) { if (self::delete_staging_item($h9COL)) { $rvLmz++; } } goto zC4hI; v51cd: } goto LvtUq; lz0Uf: $MMVuJ = $HDEgp->current_action(); goto aUemr; aUemr: if (!$MMVuJ) { return; } goto DYnyY; rejMo: exit; goto ynaCe; VvtD5: $aUipK = $_POST['staging_ids'] ?? []; goto qY2oH; i325v: $HDEgp = new SBB_Collector_Staging_List_Table(); goto lz0Uf; oeg7C: wp_redirect($yOu79); goto rejMo; ynaCe: } public static function handle_delete() : void { goto IlQ56; soDkP: self::delete_staging_item($bZzXg); goto umTPF; umTPF: wp_redirect(admin_url('admin.php?page=sbb-collector-staging&deleted=1')); goto id4CI; IlQ56: if (!current_user_can('manage_options')) { wp_die('权限不足'); } goto s6Hfa; k1UpN: check_admin_referer('sbb_collector_delete_staging_' . $bZzXg); goto soDkP; s6Hfa: $bZzXg = isset($_GET['post_id']) ? intval($_GET['post_id']) : 0; goto k1UpN; id4CI: exit; goto QNREl; QNREl: } private static function delete_staging_item(int $bZzXg) : bool { goto cKGM3; nLAat: return $McxM5 !== false && $McxM5 !== null; goto Am0wW; bBmIE: $McxM5 = wp_delete_post($bZzXg, true); goto nLAat; cKGM3: if ($bZzXg <= 0) { return false; } goto bBmIE; Am0wW: } private static function render_view_staging(int $sOFJn) : void { goto sg5XZ; pf9If: if ($tjsnf && $tjsnf->post_type === SBB_Collector_StagingStore::CPT) { goto bATmE; Aos0D: if (!empty($x369G)) { goto a1Nht; bXE73: echo '</td></tr>'; goto fJ5Qa; a1Nht: echo '<tr><th scope="row">附件</th><td>'; goto PYOle; PYOle: foreach ($x369G as $oLhh6) { echo '<img src="' . esc_url(wp_get_attachment_thumb_url($oLhh6->ID)) . '" width="150" height="150" style="margin: 5px;"/>'; } goto bXE73; fJ5Qa: } goto xXAzv; QSCSO: $x369G = get_children(['post_parent' => $sOFJn, 'post_type' => 'attachment', 'posts_per_page' => -1]); goto Aos0D; bATmE: $DUL8k = get_post_meta($sOFJn); goto iTD9L; jt0au: $gzG6a = get_post_meta($sOFJn, SBB_Collector_StagingStore::META_KEY, true); goto jmVw6; y3XRh: echo '<tr><th scope="row">标题</th><td>' . esc_html($tjsnf->post_title) . '</td></tr>'; goto cbLJr; jtefy: echo '<table class="form-table"><tbody>'; goto y3XRh; U9OhU: echo '<br><a href="' . esc_url(remove_query_arg('view_staging')) . '" class="button">返回列表</a>'; goto vs0hq; iPiQH: if (!empty($Elm06)) { echo '<tr><th scope="row">采集数据</th><td><pre>' . esc_html(print_r($Elm06, true)) . '</pre></td></tr>'; } goto QSCSO; iTD9L: echo '<h2>' . esc_html($tjsnf->post_title) . '</h2>'; goto jtefy; cbLJr: echo '<tr><th scope="row">内容</th><td>' . wp_kses_post($tjsnf->post_content) . '</td></tr>'; goto jt0au; xXAzv: echo '</tbody></table>'; goto U9OhU; jmVw6: $Elm06 = is_array($gzG6a) ? $gzG6a['extracted_data'] ?? [] : []; goto iPiQH; vs0hq: } else { wp_die('无效的暂存项 ID。'); } goto s8rSo; Jc_AN: include ABSPATH . 'wp-admin/admin-header.php'; goto Kt22E; Kt22E: echo '<div class="wrap"><h1>预览暂存项</h1>'; goto FCgKQ; s8rSo: echo '</div>'; goto bveM5; FCgKQ: $tjsnf = get_post($sOFJn); goto pf9If; sg5XZ: require_once dirname(__DIR__) . '/Core/StagingStore.php'; goto Jc_AN; bveM5: include ABSPATH . 'wp-admin/admin-footer.php'; goto F92Y_; F92Y_: } }
