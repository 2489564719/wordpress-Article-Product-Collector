# 你好

> 本文档针对插件版本：`web/app/plugins/sbb-collector`。

## 一、安装与启用

1. 确认目录结构：
   1. 将插件文件拖入项目plugins
   2. 插件目录：`web/app/plugins/sbb-collector/`
   3. 其中包含：`sbb-collector.php` 和 `collector/` 目录。

2. 进入 WordPress 后台 → 插件：
   - 找到 `SBB Collector` 插件，点击“启用”。
3. 启用成功后，左侧菜单会出现“采集器”主菜单。所有功能入口都在这里。

> 注意：
> - 若站点未启用 WooCommerce，则采集器只提供“文章采集”模式。
> - 若未启用 Polylang，多语言相关选项会自动隐藏。

---

## 二、采集器设置（全局）

菜单路径：`采集器 → 采集器设置`

这里主要控制两类全局配置：采集模式、CSF 前缀。

### 2.1 采集模式

- `产品采集`
- `文章采集`

说明：
- 不同模式会使用各自独立的“采集配置 / 暂存数据 / 发布配置”。
- 切换模式不会丢数据，只是切换“当前操作视图”。

> 若站点未启用 WooCommerce：
> - 将强制使用“文章采集”模式，后台也不会显示“产品采集”的单选项。

### 2.2 CSF 元字段前缀

用于适配不同站点的 CSF 元数据存储方式。

字段：
- `CSF 元字段前缀（产品）`
  - 默认值：`Metabox_CSF_Options`
  - 对应产品的 meta_key，例如：
    - `meta_key = Metabox_CSF_Options`
    - `meta_value = { csf_xxx: '...', csf_yyy: '...' }`
- `CSF 元字段前缀（文章）`
  - 默认值：`Metabox_CSF_Post_Options`

使用建议：
- 若你的项目就是用默认前缀，保持默认即可。
- 若其他站点使用了自定义的 CSF meta_key：
  - 直接在这里填入它们实际使用的 meta_key，采集器会自动使用新的前缀写入数据。

---

## 三、采集配置（规则配置）

菜单路径：`采集器 → 采集配置`

功能：
- 针对不同来源站点配置“采集规则”：URL 模板、列表页/详情页选择器、字段选择器等。
- 采集结果会存入“采集暂存管理”中，供后续发布使用。

典型步骤（简略）：
1. 新建一条采集配置（针对某个源站）。
2. 配置：
   - 列表页 URL 或单页 URL 模板。
   - 标题、正文、图片等字段的 CSS 选择器 / XPath。
3. 保存后，可在“单链接调试”或“批量采集”中选择该配置执行采集。

> 具体字段含义已在配置页面中有说明，这里不展开。

---

## 四、采集与暂存管理

### 4.1 单链接调试

菜单路径：`采集器 → 单链接调试`

用途：
- 针对单个 URL 测试采集配置是否正确。

流程：
1. 选择一条采集配置。
2. 输入要采集的目标 URL。
3. 点击“采集测试”，查看页面下方结果预览。
4. 确认无误后，可以选择“保存到暂存”。

### 4.2 批量采集

菜单路径：`采集器 → 批量采集`

用途：
- 针对一批 URL / 列表页进行多条内容采集并写入暂存。

流程（简略）：
1. 选择采集配置。
2. 填写 URL 列表或入口页信息。
3. 启动批量任务，任务会异步运行，结果写入“采集暂存管理”。

### 4.3 采集暂存管理

菜单路径：`采集器 → 采集暂存管理`

用途：
- 查看所有暂存记录。
- 批量发布 / 删除暂存。

常用操作：
- 查看单条暂存详情。
- 批量勾选多条，选择“发布”执行批量发布（走当前发布配置）。
- 删除不需要的暂存记录。

---

## 五、发布配置（字段映射）

菜单路径：`采集器 → 发布配置`

这是采集器的核心：定义“采集字段 → WordPress/产品字段/CSF/ACF”的映射规则。

### 5.1 字段映射

页面顶部的“字段映射”表格：
- 左侧：目标字段（如：产品标题、产品详细描述、文章标题、CSF 字段、ACF 字段等）。
- 右侧：下拉框选择“采集字段名称”（来自采集暂存的 `extracted_data` / `designated_images`）。

目标字段包含：
- 基础字段：
  - `post_title`：产品标题 / 文章标题
  - `post_content`：详细描述 / 正文
  - `post_excerpt`：简短描述 / 摘要
- SEO 字段（Yoast）：
  - `_yoast_wpseo_title`
  - `_yoast_wpseo_metadesc`
- 产品字段：
  - `_sku` 等
- CSF 字段：
  - 根据你的“自定义 CSF 字段”配置动态生成
- ACF 字段：
  - 根据你的“ACF 字段 meta_key”配置动态生成

规则：
- 每个目标字段可以映射 0 或 1 个采集字段；
- 不映射时，发布时不会写入该字段。

### 5.2 图片字段处理

配置“图集来源 / 特色图片来源”：
- 从采集字段中选择一个字段作为：
  - 产品模式：产品图集来源
  - 文章模式：文章特色图片来源
- 发布时将：
  - 将该字段中的图片 URL 或 HTML 中的图片本地化到媒体库。
  - 设置产品相册 / 文章特色图片。

### 5.3 发布选项

- `直接发布`：
  - 开启后，在“采集暂存管理”中点击“发布”会直接按映射规则创建产品/文章；
  - 关闭时，可先在“发布采集”页面做手动映射调试（仅限产品模式）。
- `产品语言`（仅在启用 Polylang 时出现）：
  - 选择发布时的语言 slug（例如 `zh`、`en`）。
  - 发布时会自动设置对应语言，并尽量使用该语言下的分类翻译。

### 5.4 默认分类

- 根据当前模式：
  - 产品模式：`product_cat`
  - 文章模式：`category`
- 可选择一个默认分类，发布时自动挂载。
- 若使用 Polylang，分类列表会根据上方选择的语言在前端自动过滤，仅显示当前语言的分类。

### 5.5 高级字段设置：CSF + ACF

#### 5.5.1 自定义 CSF 字段

- 文本区域：`自定义 CSF 字段`
- 输入格式：
  - 每行一条记录，使用 `|` 分隔：
    - `显示名称|CSF字段ID`
- 示例：
  - `产品简介|csf_art_editor_pro_introduction`
  - `型号说明|csf_art_editor_MPM`

说明：
- `显示名称`：
  - 会作为“字段映射”下拉框中的选项文本，方便识别。
- `CSF 字段ID`：
  - 即 CSF 配置中的字段 ID（数组键），不包含前缀：
    - 例如数组结构为：
      - `Metabox_CSF_Options['csf_art_editor_pro_introduction']`，则字段 ID 为 `csf_art_editor_pro_introduction`。
- 保存后：
  - 插件会按当前模式选择对应前缀：
    - 产品：`CSF前缀（产品）[字段ID]`
    - 文章：`CSF前缀（文章）[字段ID]`
  - 并在“字段映射”中以“显示名称”作为目标字段名称展示。

兼容旧格式：
- 若某行不含 `|`，整行会被视为 `字段ID`，显示名称 = 字段ID。

#### 5.5.2 ACF 字段 meta_key

- 文本区域：`ACF 字段 meta_key`
- 输入格式：
  - 每行一个 meta_key（通常是 ACF 字段名称）：
    - 例如：
      - `product_subtitle`
      - `product_feature_list`
- 保存后：
  - “字段映射”中会出现：
    - `ACF: product_subtitle`
    - `ACF: product_feature_list`
  - 发布时会将映射的采集值写入对应的 post meta：
    - `update_post_meta($post_id, 'product_subtitle', $value)`
  - ACF 会自动从这些 meta 中读取并显示。

---

## 六、发布采集

菜单路径：`采集器 → 发布采集`

用途：
- 针对单条暂存记录进行“手动映射 + 创建产品”（主要用于产品模式调试）。

流程：
1. 在“采集暂存管理”中点击某条记录的“发布”进入本页。
2. 页面会展示：
   - 左侧：目标字段列表（同上）。
   - 右侧：下拉选择采集字段。
3. 映射完毕后，点击“创建产品”：
   - 会以 `draft` 状态创建 WooCommerce 产品；
   - 并写入：标题、内容、分类、CSF、ACF、图集等。

> 实际常用场景：
> - 初次配置某个新站点时，先在这里调试映射是否正确；
> - 稳定之后，日常使用直接通过“发布配置 + 暂存管理里的批量发布”即可。

---

## 七、常见建议与注意事项

1. 先配置好“采集配置”，再做“发布配置”。
2. 发布配置中的映射和高级字段设置是“按当前模式（产品/文章）生效”的，切换模式时有独立的一套。
3. CSF/ACF 建议：
   - 先在主题或站点中配置好这些字段；
   - 再来采集器中填写：
     - CSF：前缀 + 字段 ID（通过“采集器设置 + 自定义 CSF 字段”配置）。
     - ACF：meta_key。
4. 若迁移到其他站点：
   - 只需调整：
     - `采集器设置` 中的 CSF 前缀；
     - `发布配置` 中的 CSF 字段 ID / ACF meta_key；
   - 一般无需修改插件代码。

如后续你在使用过程中遇到具体场景（某个字段写不到、图片异常、多语言分类不对等），可以在对应页面截图/描述，我再帮你针对性补充这份文档的“故障排查”章节。
